function GitleIssues(){}$.fn.bookingParser=function(){return this.change(function(){var o=$($(this).data("minutes-field")),n=$(this).val().replace(",","."),f=n,u=n,t,e,r,i;if(/^[0-9]+$/i.test(n)&&(t=parseInt(n),t>9&&t<=60?(r=parseInt(t/60),i=t-r*60,f=r+":"+(i<10?"0"+i:i),u=t):(f=t+":00",u=t*60)),/^([0-9]+):([0-9]{2})$/i.test(n)){var s=n.split(":"),e=parseFloat(s[0]),h=parseFloat(s[1]);u=e*60+h}/^([0-9]+)\.([0-9]+)$/i.test(n)&&(e=parseFloat(n),u=e*60,r=parseInt(n),i=(e-r)*60,f=r+":"+(i<10?"0"+i:i));$(this).val(f);o.val(u);o.trigger("change")})};$.fn.gitleSearch=function(){return this.each(function(){var n=$(this);n.autocomplete({serviceUrl:"/search",autoSelectFirst:!0,onSelect:function(n){window.location=n.data}});$(document).keydown(function(t){t.which==70&&t.ctrlKey&&t.shiftKey&&n.focus()})})};$.fn.liveComments=function(){return this.each(function(){var r=$(this).data("live-comments"),n=$(this),t=$("<div>").addClass("comments").html(marked(n.val())),i=$("<div>").addClass("comments-container").insertAfter(n).append(t).append(n);t.click(function(){i.addClass("edit");n.focus()});n.blur(function(){$.ajax({url:r,method:"POST",dataType:"text",data:{comment:n.val()},success:function(n){t.html(marked(n));i.removeClass("edit")},error:function(){console.log("niet opgeslagen")}})})})};$.fn.startEndDatePreset=function(){return this.click(function(){$($(this).data("insert-startdate-to")).val($(this).data("insert-startdate"));$($(this).data("insert-enddate-to")).val($(this).data("insert-enddate"))})};$.fn.initProjectTypeNumbers=function(){return this.change(function(){var n=$($(this).data("numberfield")),t=$(this).val();switch(t){case"1":n.val(n.data("initial-number"));break;case"2":case"4":n.val(n.data("service-number"));break;case"3":n.val(n.data("internal-number"));break;default:n.val("")}$($(this).data("insert-startdate-to")).val($(this).data("insert-startdate"));$($(this).data("insert-enddate-to")).val($(this).data("insert-enddate"))})};$(function(){var n=undefined,t;$(".booking-edit").on("click",function(t){t.preventDefault();var i=$(this).parents(".booking-row");n!=undefined&&(n.find(".booking-row-edit").remove(),n.find(".booking-row-content").show());n=i;$.ajax({method:"GET",data:{id:i.data("id")},url:"/booking/edit",success:function(n){i.find(".booking-row-content").hide();i.prepend(n);e(i);f(i)}})});$(".booking-row").on("click",function(n){if(!$(n.target).is('input[type="checkbox"], a')){n.stopPropagation();var t=$(this).find(".select-booking");t.prop("checked",!t.prop("checked"));t.trigger("change")}});$(".select-booking").off("change").on("change",function(){$(this).parents(".booking-row-content").toggleClass("selected",$(this).prop("checked"));$("#move-bookings-date, #move-bookings-button").toggle($(".select-booking:checked").length>0)});var e=function(t){t.find(".booking-edit-cancel").on("click",function(i){i.preventDefault();t.find(".booking-row-edit").remove();t.find(".booking-row-content").show();n=undefined})},i={format:"dd-mm-yyyy",weekStart:1},r=function(n){n.find(".booking-row-null-toggle").addClass("null");n.find(".booking_Unbillable").val(1)},u=function(n){n.find(".booking-row-null-toggle").removeClass("null");n.find(".booking_Unbillable").val(0)},f=function(n){n.find(".project-chooser").data("suggestion",undefined);n.find(".project-chooser").autocomplete({serviceUrl:"/project/autocomplete",autoSelectFirst:!0,noCache:!0,minChars:0,onSelect:function(t){var i=n.find(".project-chooser");if(i.data("suggestion")!=undefined&&i.data("suggestion")==t.data)return!1;i.data("suggestion",t.data).val(t.value);n.find(".booking_Project_Id").val(t.data);n.find(".booking_Project_Slug").val(t.extraValue3);n.find(".issue-chooser").val("").autocomplete("setOptions",{params:{projectId:t.data}});n.find(".booking_Issue_Id").val("");t.extraValue=="ticketRequired"?(n.find(".issue-chooser").prop("required",!0),$(document).foundation("abide","reflow")):(n.find(".booking_Comment").prop("required",!0),$(document).foundation("abide","reflow"));t.extraValue2=="unbillable"?r(n):u(n)}}).on("focus",function(){$(this).autocomplete().onValueChange()});n.find(".issue-chooser").autocomplete({serviceUrl:"/issue/autocomplete",params:{projectId:n.find(".booking_Project_Id").val()},autoSelectFirst:!0,noCache:!0,minChars:1,width:n.find(".project-chooser").width(),onSelect:function(t){n.find(".booking_Issue_Id").val(t.data);n.find(".booking_Issue_Id").trigger("change");n.find(".issue-chooser").val(t.value);n.find(".booking_Comment").prop("required",!1);$(document).foundation("abide","reflow")}}).blur(function(){$(this).val()==""&&n.find(".booking_Issue_Id").val("")});n.find(".booking-row-null-toggle").click(function(t){t.preventDefault();$(this).hasClass("null")?u(n):r(n)});n.find(".new-issue").click(function(){var t=n.find(".booking_Project_Slug").val();if(t=="")return!1;$("#newIssue").foundation("reveal","open",{url:"/project/"+t+"/issue/new?cancelLayout=true",success:function(){setTimeout(function(){var i=new GitleIssues;i.initTimeParser();$("#newIssue").find("form").submit(function(i){i.preventDefault();$.ajax({url:"/project/"+t+"/issue/0/ajaxsave",method:"POST",data:$(this).serialize(),success:function(t){n.find(".booking_Issue_Id").val(t.Id).parent().removeClass("error");n.find(".issue-chooser").val("#"+t.Number+" - "+t.Name);n.find(".booking_Comment").prop("required",!1).focus();$(document).foundation("abide","reflow");$("#newIssue").foundation("reveal","close")}})});$("#newIssue").find("#back-button").on("click",function(n){n.preventDefault();$("#newIssue").foundation("reveal","close")})},100)}}).on("opened.fndtn.reveal",function(){$(this).find('[name="item.Name"]').focus()})});n.find(".date").fdatepicker(i);n.find(".booking-parser").bookingParser()};f($(".booking-row-new"));$(".date").fdatepicker(i).on("show",function(){$("[data-dayshift]").removeClass("active")});$(".reportdate").fdatepicker({format:"yyyy-mm-dd",weekStart:1}).on("changeDate, change",function(n){var t=$("#query").val(),i=$(n.target),r=i.data("filter-prefix"),u=new RegExp(r+":[a-zA-Z0-9-_,.]+");t=t.replace(u,"");t=t+" "+r+":"+i.val();$("#query").val(t.replace(/ +(?= )/g,""));$("#query-form").submit()});t="dd MMM";(new FoundationHelper).getCurrentSizeClass()==="large"&&(t="ddd dd MMM");$("[data-dayshift]").each(function(){var i=$(this).data("dayshift"),n="",r=Date.today().add(i).days();r.toString("dd-MM-yyyy")===$("#booking_Date").val()&&$(this).addClass("active");switch(i){case 0:n="Vandaag";break;case-1:n="Gisteren";break;default:n=r.toString(t)}$(this).text(n)}).click(function(n){n.preventDefault();var t=$(this).data("dayshift"),i=Date.today().add(t).days();$("#booking_Date").val(i.toString("dd-MM-yyyy")).change()});$("#booking_Date").change(function(){window.location="/Booking/index?date="+$(this).val().toString("dd-MM-yyyy")})});$(".filter-select").prepend('<li><input type="text" class="filter-field" style="margin-bottom:0;"><\/li>').each(function(){var t=$(this),n=t.find(".filter-field");n.attr("placeholder","Filter");n.keyup(function(){t.find("a").each(function(){!(n.val().length>0)||$(this).hasClass("remove-filter")||$(this).html().toLowerCase().indexOf(n.val().toLowerCase())>0?$(this).parent("li").show():$(this).parent("li").hide()})})});$(".dropdown").each(function(){$(this).next().on("opened.fndtn.dropdown",function(){var n=$(this).find(".filter-field").val("").trigger("keyup");setTimeout(function(){n.focus()},50)})});$(function(){var i=function(n){var r=$(".invoiceline[data-issue="+n+"]"),t=r.find(".invoiceline-hours"),u=parseFloat(t.text()),i=r.find(".invoiceline-estimate"),f=parseFloat(i.text());u<f?(i.addClass("success"),t.addClass("alert")):(i.addClass("alert"),t.addClass("success"))},t=function(t){var i=parseFloat($("#invoice_HourPrice").val().replace(",",".")),r=parseFloat(t.find(".invoiceline-hours-input").val().replace(",",".")),u=parseInt(t.find(".invoiceline-null").val()),f=r*i*(1-u);t.find(".invoiceline-price").val(f.toFixed(2).toString().replace(".",","));n()},n=function(){var n=0,t,r,i,u;$(".invoiceline").each(function(){var t=parseFloat($(this).find(".invoiceline-price").val().replace(",","."))*(1-parseInt($(this).find(".invoiceline-null").val()));n+=t});t=0;$(".correctionline").each(function(){var n=$(this).find(".correctionline-price").val();n&&(t+=parseFloat(n.replace(",",".")))});n+=t;$("#invoice_Subtotal").val(n.toFixed(2).toString().replace(".",","));r=parseInt($(".vatline .vatline-vat").val());i=(n+t)*r*.21;$(".vatline-price").val(i.toFixed(2).toString().toString().replace(".",","));u=n+t+i;$("#invoice_Total").val(u.toFixed(2).toString().replace(".",","))};$(".invoiceline-issue").each(function(){i($(this).data("issue"))});$("#invoice_HourPrice").keyup(function(){$(".invoiceline").each(function(){t($(this))})}).keyup();n();$(".invoiceline-hours-input").on("change keyup",function(){var n;$(this).data("changed",!0);n=$(this).parents(".invoiceline");t(n);n.find(".invoiceline-estimate, .invoiceline-hours").removeClass("active");var i=parseFloat($(this).val().replace(",",".")),r=parseFloat(n.find(".invoiceline-estimate").text().replace(",",".")),u=parseFloat(n.find(".invoiceline-hours").text().replace(",","."));i==r?n.find(".invoiceline-estimate").addClass("active"):i==u&&n.find(".invoiceline-hours").addClass("active")});$(".correctionline-price").keyup(function(){n()});$(".invoiceline-estimate, .invoiceline-hours, .invoiceline-extrahours").click(function(n){n.preventDefault();var i=$(this).text(),t=$(this).parents(".invoiceline");t.find(".invoiceline-hours-input").val(i).change();t.find(".invoiceline-estimate, .invoiceline-hours, .invoiceline-extrahours").removeClass("active");$(this).addClass("active")});$(".remove-line").click(function(t){t.preventDefault();var i=$(this).parents(".invoiceline");i.data("issue")&&$(".booking[data-issue="+i.data("issue")+"]").remove();i.remove();n()});$(".invoiceline-null-toggle").click(function(i){i.preventDefault();var r=$(this).parents(".invoiceline");$(this).hasClass("null")?($(this).removeClass("null"),r.find(".invoiceline-null").val(0),r.find(".invoiceline-price").removeClass("null")):($(this).addClass("null"),r.find(".invoiceline-null").val(1),r.find(".invoiceline-price").addClass("null"));t(r);n()});$(".vatline-toggle").click(function(t){t.preventDefault();var i=$(this).parents(".vatline");$(this).hasClass("vat")?($(this).removeClass("vat"),i.find(".vatline-vat").val(1),i.find(".vatline-price").removeClass("null")):($(this).addClass("vat"),i.find(".vatline-vat").val(0),i.find(".vatline-price").addClass("null"));n()});$("#createinvoice input.comma").each(function(){$(this).keypress(function(n){var i,t,r;if(n.keyCode=="46")return document.selection?(i=document.selection.createRange(),i.text=","):this.selectionStart||this.selectionStart=="0"?(t=this.selectionStart,r=this.selectionEnd,$(this).val($(this).val().substring(0,t)+","+$(this).val().substring(r,$(this).val().length)),this.selectionStart=t+1,this.selectionEnd=t+1):$(this).val($(this).val()+","),!1})});$(".correctionline").hide();$(".correctionline").first().show();$(".correctionline").find(".correctionline-price").change(function(){$(this).find(".correctionline-price").val()!=""&&$(this).parents(".correctionline").next(".correctionline").show()});$("[data-booking]").each(function(){var n=$(this),r=parseFloat(n.find(".booking-hours").val().replace(",",".")),f=n.data("issue"),i=$(".invoiceline-issue[data-issue="+f+"]"),u=i.find(".invoiceline-hours-input");n.find(".delete-booking").click(function(f){var h,o,s,e;f.preventDefault();n.remove();h=parseFloat(u.val().replace(",","."))-r;u.data("changed")||u.val(h.toString().replace(".",","));n.data("billable")==="True"&&(o=i.find(".invoiceline-hours"),o.html((parseFloat(o.text().replace(",","."))-r).toString().replace(".",",")),s=i.find(".invoiceline-extrahours"),e=parseFloat(s.text().replace(",","."))-r,e<0&&(e=0),s.html(e.toString().replace(".",",")));t(i)})})});GitleIssues.prototype={init:function(){this.initFilters();this.initThreeStateChecker();this.initGroupActions();this.initQuickView();this.initBookingsChart();this.initTimeParser();this.bookingRowInit()},initFilters:function(){function n(n){return n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}$("a[data-filter], a[data-filter-clear]").click(function(t){var f,o,s,e;t.preventDefault();var u=$(this).data("filter"),r=$(this).data("filter-opposite"),i=$("#query").val();if($(this).is("[data-filter-clear]")&&(i=""),i.indexOf(r)!=-1&&(i=i.replace(r,"")),r!=undefined&&r.indexOf(",")!==-1&&r.indexOf(":")===-1){f=r.split(",");for(o in f)s=new RegExp(f[o]+":[a-zA-Z0-9-_,.]+"),i=i.replace(s,"")}e=i.match("\\b("+n(u)+")");i=e!=null&&i.indexOf(e[0])!=-1?i.replace(new RegExp("\\b("+n(u)+")"),""):i+" "+u;$("#query").val(i.replace(/ +(?= )/g,""));$("#query-form").submit()})},initThreeStateChecker:function(){$(".three-state-checker").each(function(){var t=$(this),i,n;t.append('<i class="fa fa-square-o none"><\/i><i class="fa fa-check-square-o all"><\/i><i class="fa fa-minus-square-o some"><\/i>');i=$(this).data("selector");n=$(i);n.click(function(){n.length==n.filter(":checked").length?t.attr("data-state","all"):n.filter(":checked").length===0?t.attr("data-state","none"):t.attr("data-state","some")})}).click(function(){var t=$(this).data("selector"),i=$(this).attr("data-state"),n=$(t);switch(i){case"none":n.attr("checked","checked");$(this).attr("data-state","all");break;default:n.removeAttr("checked");$(this).attr("data-state","none")}n.change()})},initGroupActions:function(){$("#group-actions").hide();$(".issues input[type=checkbox][name=issue]").change(function(){var t=$(".issues input[type=checkbox][name=issue]:checked"),n;t.length>0?$("#group-actions, #exportselection").show():$("#group-actions, #exportselection").hide();n=[];t.each(function(){n.push($(this).val())});$("#group-actions [name=issues]").val(n.join(","))}).change();$("[data-group-action]").click(function(n){n.preventDefault();var i=$("#group-actions input[name=issues]").val(),t=$(this).prop("href");location.href=t+(t.indexOf("?")==-1?"?":"&")+"issues="+i});$(".issue").click(function(){var n=$(this).find("input[type=checkbox]");n.prop("checked",!n.is(":checked")).change()}).on("click","a, input",function(n){n.stopPropagation()})},initQuickView:function(){var n=800;$("[data-quickview]").hover(function(){var t=$(this),r,i;$(this).data("tooltip")==undefined?(r=$(this).position(),i=$('<div class="quickview">').css("top",r.top+$(this).height()).css("left",r.left).css("z-index",10),$(this).data("tooltip",i),i.load($(this).data("quickview"),function(){i.find(".marked").each(function(){$(this).html(marked($(this).html()))});t.append(i.hide());t.data("timeout",setTimeout(function(){t.is(":hover")&&t.data("tooltip").show()},n))})):t.data("timeout",setTimeout(function(){t.is(":hover")&&t.data("tooltip").show()},n))},function(){$(".quickview").hide()})},initBookingsChart:function(){var n=0;$("[data-bookingschart]").hover(function(){var t=$(this),r,i;$(this).data("tooltip")==undefined?(r=$(this).position(),i=$('<div class="bookingschart">').css("top",r.top+$(this).height()).css("left",r.left),$(this).data("tooltip",i),i.load($(this).data("bookingschart"),function(){i.find(".marked").each(function(){$(this).html(marked($(this).html()))});t.append(i.hide());t.data("timeout",setTimeout(function(){t.is(":hover")&&t.data("tooltip").show()},n))})):t.data("timeout",setTimeout(function(){t.is(":hover")&&t.data("tooltip").show()},n))},function(){$(".bookingschart").hide()})},initTimeParser:function(){$(".time-parser").blur(function(){var n=$(this).val(),t;n!==""&&n!=="0"&&(n=n.replace(/[A-Za-z$-]/g,""),n=n.replace(",","."),n=parseFloat(n),t=n<.25,t&&(n=.25),n=n.toString().replace(".",","),$(this).val(n),t&&$(this).error("minimum is een kwartier"))})},bookingRowInit:function(){var n=$(".project-chooser-issue").parent();n.find(".project-chooser-issue").data("suggestion",undefined);n.find(".project-chooser-issue").autocomplete({serviceUrl:"/project/autocomplete",autoSelectFirst:!0,noCache:!0,minChars:0,onSelect:function(t){var i=n.find(".project-chooser-issue");if(i.data("suggestion")!=undefined&&i.data("suggestion")==t.data)return!1;i.data("suggestion",t.data).val(t.value);n.find(".issue_Project_Id").val(t.data);n.find(".issue_Project_Slug").val(t.extraValue3)}}).on("focus",function(){$(this).autocomplete().onValueChange()})}};var gitleIssues=null;$(function(){gitleIssues=new GitleIssues;gitleIssues.init()});